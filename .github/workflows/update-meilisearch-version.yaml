name: Update Meilisearch Version

on:
  repository_dispatch:
    types: [meilisearch-release]
  # For testing purposes
  workflow_dispatch:
    inputs:
      version:
        description: 'Meilisearch version to test (e.g., v1.25.0)'
        required: true
        type: string

jobs:
  update-version:
    name: Update Meilisearch version and create PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get version from payload
        id: version
        run: |
          # Support both repository_dispatch (client_payload) and workflow_dispatch (inputs)
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi

          # Sanitize: remove newlines, carriage returns, and % characters to prevent injection
          VERSION=$(printf '%s' "$VERSION" | tr -d '\n\r%')

          if [ -z "$VERSION" ]; then
            echo "::error::No version provided in payload"
            exit 1
          fi

          # Validate against SemVer pattern (optional v prefix, MAJOR.MINOR.PATCH, optional pre-release/build)
          SEMVER_REGEX='^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'
          if ! [[ "$VERSION" =~ $SEMVER_REGEX ]]; then
            echo "::error::Invalid version format '$VERSION'. Expected SemVer (e.g., v1.2.3 or 1.2.3-beta.1)"
            exit 1
          fi

          echo "new_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "üì¶ New Meilisearch version: $VERSION"

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep -oP 'appVersion: "\K[^"]+' charts/meilisearch/Chart.yaml)
          echo "current_version=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "üìå Current version: $CURRENT"

      - name: Check if update is needed
        id: check
        run: |
          if [ "${{ steps.version.outputs.new_version }}" = "${{ steps.current.outputs.current_version }}" ]; then
            echo "::notice::Version ${{ steps.version.outputs.new_version }} is already the current version"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Chart.yaml
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Update appVersion
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          # Escape sed-special characters (/, &, \)
          ESCAPED_VERSION=$(printf '%s\n' "$NEW_VERSION" | sed 's/[\/&]/\\&/g')
          sed -i "s/^appVersion: .*/appVersion: \"$ESCAPED_VERSION\"/" charts/meilisearch/Chart.yaml

          # Increment chart minor version (e.g., 0.17.1 -> 0.18.0)
          CURRENT_CHART_VERSION=$(grep -oP '^version: \K.*' charts/meilisearch/Chart.yaml)

          # Validate CURRENT_CHART_VERSION is not empty
          if [ -z "$CURRENT_CHART_VERSION" ]; then
            echo "::error::Failed to parse 'version' from Chart.yaml (empty or missing)"
            exit 1
          fi

          MAJOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f2)

          # Validate MAJOR and MINOR are numeric
          if ! [[ "$MAJOR" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid MAJOR version '$MAJOR' (expected numeric) in Chart.yaml version '$CURRENT_CHART_VERSION'"
            exit 1
          fi
          if ! [[ "$MINOR" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid MINOR version '$MINOR' (expected numeric) in Chart.yaml version '$CURRENT_CHART_VERSION'"
            exit 1
          fi

          NEW_MINOR=$((MINOR + 1))
          NEW_CHART_VERSION="${MAJOR}.${NEW_MINOR}.0"
          sed -i "s/^version: .*/version: $NEW_CHART_VERSION/" charts/meilisearch/Chart.yaml
          echo "üìä Chart version: $CURRENT_CHART_VERSION -> $NEW_CHART_VERSION"

      - name: Update README.md compatibility section
        if: steps.check.outputs.needs_update == 'true'
        run: |
          sed -i "s|version v[0-9.]*[0-9] of Meilisearch|version ${{ steps.version.outputs.new_version }} of Meilisearch|g" README.md
          sed -i "s|meilisearch/releases/tag/v[0-9.]*[0-9]|meilisearch/releases/tag/${{ steps.version.outputs.new_version }}|g" README.md

      - name: Update values.yaml
        if: steps.check.outputs.needs_update == 'true'
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          yq eval '.image.tag = strenv(NEW_VERSION)' -i charts/meilisearch/values.yaml

      - name: Regenerate manifests
        if: steps.check.outputs.needs_update == 'true'
        run: |
          helm template meilisearch charts/meilisearch | grep -v 'helm.sh/chart:\|app.kubernetes.io/managed-by:' > manifests/meilisearch.yaml

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.MEILI_BOT_GH_PAT }}
          commit-message: "chore(version): bump Meilisearch to ${{ steps.version.outputs.new_version }}"
          title: "‚¨ÜÔ∏è Bump Meilisearch to ${{ steps.version.outputs.new_version }}"
          body: |
            ## Description

            This PR updates Meilisearch to version `${{ steps.version.outputs.new_version }}`.

            ## Changes

            - Updated `appVersion` in `Chart.yaml`
            - Bumped chart `version` (minor) in `Chart.yaml`
            - Updated `image.tag` in `values.yaml`
            - Updated compatibility section in `README.md`
            - Regenerated `manifests/meilisearch.yaml`

            ## Release notes

            See the [Meilisearch ${{ steps.version.outputs.new_version }} release notes](https://github.com/meilisearch/meilisearch/releases/tag/${{ steps.version.outputs.new_version }}).

            ---
            ü§ñ *This PR was automatically created by the [update-meilisearch-version](.github/workflows/update-meilisearch-version.yaml) workflow.*
          branch: "bump/meilisearch-${{ steps.version.outputs.new_version }}"
          base: main
          labels: |
            dependencies
            automated
          delete-branch: true

